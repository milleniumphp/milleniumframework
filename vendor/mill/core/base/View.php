<?php

namespace mill\core\base;

/**
 * !DO NOT EDIT this file without knowledge of what you are doing
 * @author Yaroslav Palamarchuk
 */
class View {

    /**
     * for real route
     * @var $route array
     * */
    public $route = [];

    /**
     * for view file 
     * @var $view string
     * */
    public $view;

    /**
     * for layout file
     * @var $layout string
     * */
    public $layout;

    /**
     * title of page
     * @var string 
     */
    public $title;

    /**
     * description of page
     * @var string 
     */
    public $description;

    /**
     * keywords of page 
     * @var string 
     */
    public $keywords;

    /**
     * css and js files
     * @var array 
     */
    public $scripts = [];
    
    public $scriptsCache = true;
    
    public $searchMin = [
            '/(\n)+/',
            '/\r\n+/',
            '/\n(\t)+/',
            '/\n(\ )+/',
            '/\>(\n)+</',
            '/\r\n</'
        ];
    public $replaceMin = [
            "\n",
            "\n",
            "\n",
            "\n",
            '><',
            '><'
        ];

    /**
     * register view and layout
     * @param array $route for real routes
     * */
    public function __construct($route, $layout = '', $view = '') {
        $this->route = $route;
        if ($layout === false) {
            $this->layout = false;
        } else {
            $this->layout = $layout ?: LAYOUT;
        }
        $this->view = $view;

    }

    protected function compressPage($buffer) {
        return preg_replace($this->searchMin, $this->replaceMin, $buffer);
    }

    /**
     * for variables from controller to view
     * @param array $vars for variables
     * */
    public function render($vars, $metatags, $scripts) {
        $this->route['prefix'] = str_replace('\\', '/', $this->route['prefix']);
        /**
         * you can get this var in your layout and without function scripts() get all scripts
         */
        $scripts = $this->getScripts($scripts);
        //if variables in array get it
        if (is_array($vars))
            extract($vars);
        /**
         * view file name
         * @var string
         */
        if($this->route['prefix'] == true){
            $file_view = SECTIONS . "/{$this->route['prefix']}views/{$this->route['controller']}/{$this->view}.php";
        }else{
            $file_view = APP . "/views/{$this->route['prefix']}{$this->route['controller']}/{$this->view}.php";
        }
        if(GZIP){
            ob_start([$this, 'compressPage']);
        }else{
            ob_start();
        }

        //if file exists
        if (is_file($file_view)) {
            require $file_view;
        } else {
            throw new \Exception("<b>View {$file_view} not found</b>", 404);
        }
        /**
         * content from view file
         * @var string
         */
        $content = ob_get_contents();
        ob_clean();

        $this->title = $metatags['title'];
        $this->description = $metatags['description'];
        $this->keywords = $metatags['keywords'];

        if (false !== $this->layout) {
            /**
             * layout file full path
             * @var string
             */
            if($this->route['prefix'] === true){
                $file_layout = SECTIONS . "/{$this->route['prefix']}views/layouts/{$this->layout}.php";
            }else{
                $file_layout = APP . "/views/layouts/{$this->layout}.php";
            }
            
            if (is_file($file_layout)) {
                require $file_layout;
            } else {
                throw new \Exception('<b>Layout '. $file_layout . ' not found</b>', 404);
            }
        }else{
            echo $content;
        }
    }

    public function getScripts($scripts) {
        $s = require ROOT . '/config/scripts.php';
        if(DEBUG && DEBUGBAR){
            /**
             * debug bar js file
             */
            $s['js'][] = '/assets/mill/system/js/debugbar/debugbar.js';
        }
        
        /**
         * first array loop
         */
        foreach ($s as $name => $script) {
            foreach ($script as $sc) {
                $this->scripts[$name][] = $sc;
            }
        }
        /**
         * second array loop
         */
        foreach ($scripts as $name => $script) {
            foreach ($script as $sc) {
                $this->scripts[$name][] = $sc;
            }
        }
        return $this->scripts;
    }

    /**
     * makes script tags
     */
    public function scripts() {
        foreach ($this->scripts['js'] as $script) {
            echo "<script src='" . $script . "'> </script>";
        }
    }
    
    public function addScript($ar = []){
        foreach ($ar as $t => $n){
            foreach($n as $k => $v){
                $this->scripts[$t][] = $v;
            }
        }
    }

    public function miniscripts($js) {
        if (\mill\core\App::$app->cache->get($js) && ($this->scriptsCache === true)) {
            if(!file_exists(ROOT . '/public/js/minified/' . $js )){
                file_put_contents(ROOT . '/public/js/minified/' . $js, \mill\core\App::$app->cache->get($js));
            }
        }else{
            $minified = '';
            foreach ($this->scripts['js'] as $script) {
                if (preg_match("/https:/", $script, $match)) {
                    $s = file_get_contents($script);
                } else {
                    $s = file_get_contents('http://' . \mill\html\Url::domain() . '/' . $script);
                }
                $minified .= $s;
            }
            $data = preg_replace($this->searchMin, $this->replaceMin, $minified);
            
            \mill\core\App::$app->cache->set($js, $data);
            file_put_contents(ROOT . '/public/js/minified/' . $js, $data);
            
        }
        echo "<script src='/js/minified/$js'></script>";
    }

    public function styles() {
        foreach ($this->scripts['css'] as $script) {
            echo "<link href='/" . ltrim($script, '/') . "' rel='stylesheet'>";
        }
    }

}
